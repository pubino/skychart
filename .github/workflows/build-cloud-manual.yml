name: Build SkyChart macOS ARM64 (Cloud - Manual)

# Manual-only cloud builds to avoid long queues
on:
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release after successful build'
        required: false
        default: false
        type: boolean

# Set permissions for GITHUB_TOKEN
permissions:
  contents: read
  actions: read
  checks: write

jobs:
  # Cloud build job - manual trigger only
  build-cloud:
    name: Build on GitHub-hosted macOS ARM64 (Manual)
    # Use the new ARM64 macOS runners (when available)
    runs-on: macos-15-arm64
    timeout-minutes: 90  # Longer timeout for cloud builds
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup environment info
      run: |
        echo "ðŸŒ©ï¸ Running on GitHub-hosted ARM64 runner"
        echo "Runner OS: $(uname -a)"
        echo "CPU Architecture: $(uname -m)"
        echo "Available disk space:"
        df -h
        echo "Memory info:"
        system_profiler SPHardwareDataType | grep Memory
    
    - name: Install Homebrew dependencies
      run: |
        echo "ðŸ“¦ Installing dependencies via Homebrew..."
        # Install Qt5 and Free Pascal Compiler
        brew install qt@5 fpc
        
        # Verify installations
        echo "Qt5 version:"
        brew list --versions qt@5
        echo "FPC version:"
        fpc -iV
        echo "FPC target:"
        fpc -iTP
    
    - name: Setup Qt5 environment
      run: |
        echo "âš™ï¸ Setting up Qt5 environment..."
        echo "Qt5 installation:"
        ls -la /opt/homebrew/Cellar/qt@5/ || ls -la /usr/local/Cellar/qt@5/ || true
        
        # Set environment variables for Qt5
        if [ -d "/opt/homebrew/Cellar/qt@5" ]; then
          echo "QT5_DIR=/opt/homebrew/Cellar/qt@5" >> $GITHUB_ENV
          echo "DYLD_FRAMEWORK_PATH=/opt/homebrew/Cellar/qt@5/*/lib:$DYLD_FRAMEWORK_PATH" >> $GITHUB_ENV
          echo "/opt/homebrew/Cellar/qt@5/*/bin" >> $GITHUB_PATH
        elif [ -d "/usr/local/Cellar/qt@5" ]; then
          echo "QT5_DIR=/usr/local/Cellar/qt@5" >> $GITHUB_ENV
          echo "DYLD_FRAMEWORK_PATH=/usr/local/Cellar/qt@5/*/lib:$DYLD_FRAMEWORK_PATH" >> $GITHUB_ENV
          echo "/usr/local/Cellar/qt@5/*/bin" >> $GITHUB_PATH
        fi
    
    - name: Clone and build Lazarus with Qt5
      run: |
        echo "ðŸ—ï¸ Building Lazarus with Qt5 support..."
        # Clone Lazarus if not exists
        if [ ! -d "lazarus" ]; then
          git clone https://gitlab.com/freepascal.org/lazarus/lazarus.git
          cd lazarus
          git checkout lazarus_3_4  # Stable branch
        else
          cd lazarus
        fi
        
        # Build Lazarus with Qt5
        make clean LCL_PLATFORM=qt5
        make bigide LCL_PLATFORM=qt5
    
    - name: Build Qt5Pas framework
      run: |
        echo "ðŸ”§ Building Qt5Pas framework..."
        if [ ! -d "Qt5Pas" ]; then
          git clone https://github.com/davidbannon/Qt5Pas.git
        fi
        cd Qt5Pas
        qmake
        make
        
        # Install Qt5Pas
        sudo make install
    
    - name: Make build scripts executable
      run: |
        chmod +x build_dependencies.sh
        chmod +x build_macos_arm64.sh
        chmod +x test_build.sh
        chmod +x package_macos.sh
    
    - name: Build dependencies
      run: |
        echo "ðŸ“¦ Building dependencies..."
        ./build_dependencies.sh 2>&1 | tee build_dependencies_cloud.log
        
        # Check if build was successful
        if [ $? -ne 0 ]; then
          echo "âŒ Dependencies build failed"
          cat build_dependencies_cloud.log
          exit 1
        fi
    
    - name: Build SkyChart
      run: |
        echo "ðŸš€ Building SkyChart on cloud ARM64..."
        ./build_macos_arm64.sh 2>&1 | tee build_skychart_cloud.log
        
        # Check if build was successful
        if [ $? -ne 0 ]; then
          echo "âŒ SkyChart build failed"
          cat build_skychart_cloud.log
          exit 1
        fi
    
    - name: Test build
      run: |
        echo "ðŸ§ª Testing build..."
        ./test_build.sh 2>&1 | tee test_build_cloud.log
    
    - name: Create distribution package
      run: |
        echo "ðŸ“¦ Creating distribution package..."
        ./package_macos.sh 2>&1 | tee package_cloud.log
        
        # List created artifacts
        echo "Created artifacts:"
        ls -la dist/ || true
        du -sh dist/* || true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()  # Upload even if tests failed
      with:
        name: skychart-cloud-arm64-build-${{ github.run_number }}
        path: |
          skychart/units/aarch64-darwin-qt5/skychart
          skychart/units/aarch64-darwin-qt5/cdcicon
          skychart/library/wcs/libcdcwcs.dylib
          dist/
          *_cloud.log
        retention-days: 30
    
    - name: Upload DMG distribution
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: skychart-cloud-arm64-dmg-${{ github.run_number }}
        path: |
          dist/*.dmg
        retention-days: 90

  # Release job (if requested)
  release:
    name: Create Release (Cloud Build)
    needs: [build-cloud]
    runs-on: ubuntu-latest
    if: ${{ success() && github.event.inputs.create_release == 'true' }}
    
    steps:
    - name: Download artifacts
      uses: actions/download-artifact@v4
      with:
        name: skychart-cloud-arm64-dmg-${{ github.run_number }}
        path: ./release/
    
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ github.run_number }}-cloud-arm64
        release_name: SkyChart Cloud ARM64 Build ${{ github.run_number }}
        body: |
          **Manual Cloud ARM64 Build**
          
          - Built on GitHub-hosted `macos-15-arm64` runner
          - Native ARM64 compilation with Qt5 widget set
          - Professional app bundle and DMG distribution
          - Build number: ${{ github.run_number }}
          - Commit: ${{ github.sha }}
          
          **Installation:**
          1. Download SkyChart-*.dmg
          2. Mount the DMG file
          3. Drag SkyChart.app to Applications folder
          4. Launch from Applications or Launchpad
          
          **System Requirements:**
          - macOS 11.0+ (Big Sur or later)
          - Apple Silicon (M1/M2/M3/M4) or Intel with Rosetta 2
        draft: false
        prerelease: true
    
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/SkyChart-macOS-ARM64.dmg
        asset_name: SkyChart-Cloud-ARM64-${{ github.run_number }}.dmg
        asset_content_type: application/octet-stream