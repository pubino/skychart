name: Build SkyChart macOS ARM64 (Self-Hosted)

on:
  push:
    branches: [ main, master, macos-arm64 ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: read
  actions: read
  checks: write

jobs:
  build-self-hosted:
    name: Build on Self-hosted macOS ARM64
    runs-on: [self-hosted, macOS, ARM64]
    timeout-minutes: 45
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: Setup environment info
      run: |
        echo "ðŸ  Running on Self-hosted ARM64 runner"
        echo "Runner OS: $(uname -a)"
        echo "CPU Architecture: $(uname -m)"
        echo "ðŸš€ Installing build environment..."
    
    - name: Install build dependencies
      run: |
        echo "ðŸ”§ Installing build dependencies..."
        brew update || true
        brew install fpc qt@5 || echo "Packages may already be installed"
        echo "âœ… FPC version: $(fpc -iV)"
        echo "âœ… Qt5 version: $(brew list --versions qt@5)"
    
    - name: Setup Qt5 environment
      run: |
        QT5_PREFIX=$(brew --prefix qt@5)
        echo "QT5_DIR=$QT5_PREFIX" >> $GITHUB_ENV
        echo "DYLD_FRAMEWORK_PATH=$QT5_PREFIX/lib:$DYLD_FRAMEWORK_PATH" >> $GITHUB_ENV
        echo "$QT5_PREFIX/bin" >> $GITHUB_PATH
        echo "âœ… Qt5 environment configured: $QT5_PREFIX"
    
    - name: Run build process
      run: |
        echo "ðŸ—ï¸ Running build process..."
        chmod +x *.sh
        
        export QT5_PREFIX=$(brew --prefix qt@5)
        export DYLD_FRAMEWORK_PATH="$QT5_PREFIX/lib:$DYLD_FRAMEWORK_PATH"
        export PATH="$QT5_PREFIX/bin:$PATH"
        
        echo "Building dependencies..."
        ./build_dependencies.sh 2>&1 | tee build_dependencies.log
        
        echo "Building SkyChart..."
        ./build_macos_arm64.sh 2>&1 | tee build_skychart.log
        
        echo "Testing build..."
        ./test_build.sh 2>&1 | tee test_build.log || true
        
        echo "Creating package..."
        ./package_macos.sh 2>&1 | tee package.log || true
        
        echo "Build artifacts:"
        find . -name "skychart" -type f 2>/dev/null || true
        ls -la dist/ || true
    
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: skychart-macos-arm64-build-${{ github.run_number }}
        path: |
          skychart/units/**/*
          skychart/library/**/*
          dist/
          *.log
        retention-days: 30
